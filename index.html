<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adaptive Macro Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark gray text */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for potentially long content */
            min-height: 100vh;
            padding: 1rem; /* Padding around the container */
        }
        .container {
            background-color: white;
            padding: 1.5rem; /* Inner padding for the main box */
            border-radius: 0.75rem; /* Rounded corners for the main box */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Standard shadow */
            width: 100%;
            max-width: 600px; /* Max width of the content area */
            margin-top: 2rem; /* Margin from the top */
            margin-bottom: 2rem; /* Margin from the bottom */
        }
        .input-group { margin-bottom: 1rem; } /* Spacing for input groups */
        .input-label { display: block; margin-bottom: 0.25rem; font-weight: 500; color: #374151; } /* Styling for labels */
        .input-field, .select-field {
            width: 100%;
            padding: 0.6rem 0.8rem; /* Padding inside input fields */
            border: 1px solid #d1d5db; /* Border for input fields */
            border-radius: 0.375rem; /* Rounded corners for input fields */
            transition: border-color 0.2s; /* Smooth transition for focus */
            appearance: none; /* Remove default styling for select, especially on Safari */
            -moz-appearance: none; /* Firefox */
            -webkit-appearance: none; /* Safari/Chrome */
            background-position: right 0.5rem center; /* Position for custom arrow */
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em; /* Size of the custom arrow */
        }
        /* Custom arrow for select elements */
        .select-field {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
        }
        /* Remove spinners from number inputs */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] { -moz-appearance: textfield; } /* Firefox */

        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #6366f1; /* Indigo focus color */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Focus ring */
        }
        .button {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #4f46e5; /* Indigo button */
            color: white;
            font-weight: 600;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
            margin-top: 1rem; /* Space above buttons */
        }
        .button:hover { background-color: #4338ca; } /* Darker indigo on hover */
        .button-secondary { background-color: #6b7280; } /* Gray secondary button */
        .button-secondary:hover { background-color: #4b5563; }
        .button-danger { background-color: #ef4444; } /* Red danger button */
        .button-danger:hover { background-color: #dc2626; }

        .info-box {
            background-color: #eef2ff; /* Indigo light background for info box */
            color: #3730a3; /* Indigo dark text for info box */
            padding: 1rem;
            border-radius: 0.375rem;
            margin-top: 1.5rem;
            border: 1px solid #c7d2fe; /* Indigo border for info box */
        }
        .info-box h3 { font-weight: 600; margin-bottom: 0.5rem; }
        .info-box p { margin-bottom: 0.25rem; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; } /* Styling for error messages */
        .success-message { color: #10b981; font-size: 0.875rem; margin-top: 0.5rem; text-align: center;} /* Styling for success messages */

        #setupScreen, #dashboardScreen { display: none; } /* Screens hidden by default, JS will show one */
        hr { margin-top: 1.5rem; margin-bottom: 1.5rem; border-color: #e5e7eb; } /* Horizontal rule styling */
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Adaptive Macro Tracker</h1>

        <div id="setupScreen">
            <h2 class="text-xl font-semibold mb-4">Initial Setup</h2>
            <p class="text-sm text-gray-600 mb-4">Please provide some basic information to get started.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="currentWeight" class="input-label">Current Weight (kg)</label>
                    <input type="number" id="currentWeight" class="input-field" placeholder="e.g., 70" step="0.1">
                </div>
                <div class="input-group">
                    <label for="height" class="input-label">Height (cm)</label>
                    <input type="number" id="height" class="input-field" placeholder="e.g., 175" step="0.1">
                </div>
                <div class="input-group">
                    <label for="age" class="input-label">Age</label>
                    <input type="number" id="age" class="input-field" placeholder="e.g., 30" step="1">
                </div>
                <div class="input-group">
                    <label for="sex" class="input-label">Sex</label>
                    <select id="sex" class="select-field">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label for="activityLevel" class="input-label">Activity Level</label>
                <select id="activityLevel" class="select-field">
                    <option value="1.2">Sedentary (little or no exercise)</option>
                    <option value="1.375">Lightly active (light exercise 1-3 days/wk)</option>
                    <option value="1.55">Moderately active (moderate exercise 3-5 days/wk)</option>
                    <option value="1.725">Very active (hard exercise 6-7 days/wk)</option>
                    <option value="1.9">Super active (very hard exercise & physical job)</option>
                </select>
            </div>
            <div class="input-group">
                <label for="proteinGoalGramsPerKg" class="input-label">Protein Target (grams per kg body weight)</label>
                <input type="number" id="proteinGoalGramsPerKg" class="input-field" value="1.8" step="0.1">
            </div>
             <div class="input-group">
                <label for="fatGoalPercentage" class="input-label">Fat Target (% of total calories, min 20%)</label>
                <input type="number" id="fatGoalPercentage" class="input-field" value="25" min="20" max="50" step="1">
            </div>
            <div class="input-group">
                <label for="weeklyGoal" class="input-label">Weekly Weight Goal</label>
                <select id="weeklyGoal" class="select-field">
                    <option value="-1">-1 kg/week (Aggressive Deficit)</option>
                    <option value="-0.75">-0.75 kg/week (Large Deficit)</option>
                    <option value="-0.5">-0.5 kg/week (Moderate Deficit)</option>
                    <option value="-0.25">-0.25 kg/week (Small Deficit)</option>
                    <option value="0" selected>Maintain Weight</option>
                    <option value="0.125">+0.125 kg/week (Small Surplus)</option>
                    <option value="0.25">+0.25 kg/week (Moderate Surplus)</option>
                    <option value="0.5">+0.5 kg/week (Large Surplus)</option>
                </select>
            </div>
            <button id="saveSetupBtn" class="button">Save Setup & Start Tracking</button>
            <p id="setupError" class="error-message"></p>
        </div>

        <div id="dashboardScreen">
            <div class="text-center mb-4">
                <p class="text-gray-600">Today: <span id="currentDateDisplay" class="font-medium"></span></p>
            </div>

            <div class="info-box mb-6">
                <h3 class="text-lg">Current Targets</h3>
                <p>Calories: <strong id="targetCaloriesDisplay">N/A</strong> kcal</p>
                <p>Protein: <strong id="targetProteinDisplay">N/A</strong> g</p>
                <p>Carbs: <strong id="targetCarbsDisplay">N/A</strong> g</p>
                <p>Fat: <strong id="targetFatDisplay">N/A</strong> g</p>
                <p class="mt-2">Estimated TDEE: <strong id="tdeeDisplay">N/A</strong> kcal (Last Check-in: <span id="lastCheckinTDEEDate">N/A</span>)</p>
            </div>

            <h2 class="text-xl font-semibold mb-3">Log Today's Data</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="logDate" class="input-label">Date</label>
                    <input type="date" id="logDate" class="input-field">
                </div>
                <div class="input-group">
                    <label for="logWeight" class="input-label">Weight (kg)</label>
                    <input type="number" id="logWeight" class="input-field" placeholder="Your weight" step="0.1">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="input-group">
                    <label for="logProtein" class="input-label">Protein (g)</label>
                    <input type="number" id="logProtein" class="input-field" placeholder="e.g., 150" step="1">
                </div>
                <div class="input-group">
                    <label for="logCarbs" class="input-label">Carbs (g)</label>
                    <input type="number" id="logCarbs" class="input-field" placeholder="e.g., 200" step="1">
                </div>
                <div class="input-group">
                    <label for="logFat" class="input-label">Fat (g)</label>
                    <input type="number" id="logFat" class="input-field" placeholder="e.g., 60" step="1">
                </div>
            </div>
            <button id="logDataBtn" class="button">Log Data for <span id="logDateDisplay">Selected Date</span></button>
            <p id="logError" class="error-message"></p>
            <p id="logSuccess" class="success-message"></p>

            <hr>

            <h2 class="text-xl font-semibold mb-3">Weekly Check-in</h2>
            <p class="text-sm text-gray-600 mb-2">Perform a check-in to update your TDEE and targets. Recommended weekly or bi-weekly with consistent logging.</p>
            <p class="text-sm text-gray-600 mb-2">Days with full logs (weight & calories) in last 4 weeks: <strong id="daysLoggedForCheckin">0</strong> (Need at least 7-10)</p>
            <button id="checkinBtn" class="button button-secondary" disabled>Perform Weekly Check-in</button>
            <p id="checkinMessage" class="mt-2 text-sm text-center"></p>

            <hr>
            <button id="viewLogsBtn" class="button button-secondary mt-2">View Logs (Console)</button>
            <button id="resetDataBtn" class="button button-danger mt-2">Reset All Data</button>
        </div>
    </div>

    <script>
        // --- Constants for calculations and app behavior ---
        const CALORIES_PER_G_PROTEIN = 4;
        const CALORIES_PER_G_CARB = 4;
        const CALORIES_PER_G_FAT = 9;
        const CALORIES_PER_KG_FAT_TISSUE = 7700; // Approx calories in 1kg of body fat tissue
        const TDEE_SMOOTHING_FACTOR = 0.3; // How much weight new TDEE calculation gets (0.3 = 30% new, 70% old)
        const CHECKIN_ANALYSIS_DAYS_WINDOW = 28; // Analyze logs from the last 28 days
        const MIN_LOGS_FOR_CHECKIN = 10; // Minimum number of full log days (weight & calories) needed in the window
        const WEIGHT_TREND_DAYS = 3; // Number of days to average for start/end weight trend calculation

        // --- DOM Element References ---
        // Setup Screen Elements
        const setupScreen = document.getElementById('setupScreen');
        const currentWeightInput = document.getElementById('currentWeight');
        const heightInput = document.getElementById('height');
        const ageInput = document.getElementById('age');
        const sexSelect = document.getElementById('sex');
        const activityLevelSelect = document.getElementById('activityLevel');
        const proteinGoalGramsPerKgInput = document.getElementById('proteinGoalGramsPerKg');
        const fatGoalPercentageInput = document.getElementById('fatGoalPercentage');
        const weeklyGoalSelect = document.getElementById('weeklyGoal');
        const saveSetupBtn = document.getElementById('saveSetupBtn');
        const setupError = document.getElementById('setupError');

        // Dashboard Screen Elements
        const dashboardScreen = document.getElementById('dashboardScreen');
        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const targetCaloriesDisplay = document.getElementById('targetCaloriesDisplay');
        const targetProteinDisplay = document.getElementById('targetProteinDisplay');
        const targetCarbsDisplay = document.getElementById('targetCarbsDisplay');
        const targetFatDisplay = document.getElementById('targetFatDisplay');
        const tdeeDisplay = document.getElementById('tdeeDisplay');
        const lastCheckinTDEEDateDisplay = document.getElementById('lastCheckinTDEEDate');
        const logDateInput = document.getElementById('logDate');
        const logWeightInput = document.getElementById('logWeight');
        const logProteinInput = document.getElementById('logProtein');
        const logCarbsInput = document.getElementById('logCarbs');
        const logFatInput = document.getElementById('logFat');
        const logDataBtn = document.getElementById('logDataBtn');
        const logDateDisplay = document.getElementById('logDateDisplay'); // Span to show formatted log date
        const logError = document.getElementById('logError');
        const logSuccess = document.getElementById('logSuccess');
        const checkinBtn = document.getElementById('checkinBtn');
        const daysLoggedForCheckinDisplay = document.getElementById('daysLoggedForCheckin');
        const checkinMessage = document.getElementById('checkinMessage');
        const viewLogsBtn = document.getElementById('viewLogsBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');

        // --- App State & localStorage Keys (using _v2 to avoid conflicts with potential older versions) ---
        const PROFILE_KEY = 'adaptiveMacroTracker_profile_v2';
        const LOGS_KEY = 'adaptiveMacroTracker_logs_v2';
        const TARGETS_KEY = 'adaptiveMacroTracker_targets_v2';

        let userProfile = {}; // Stores user's physical data and goals
        let dailyLogs = []; // Array of log objects: {date, weight, protein, carbs, fat, calories}
        let currentTargets = {}; // Stores current {calories, protein, carbs, fat, estimatedTDEE, lastTDEECalculationDate}

        // --- Utility Functions ---
        /**
         * Gets today's date in YYYY-MM-DD format.
         * @returns {string} Today's date.
         */
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Formats a YYYY-MM-DD date string into a more readable format.
         * @param {string} dateString - The date string to format.
         * @returns {string} Formatted date or 'N/A'.
         */
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            // Add T00:00:00 to ensure date is interpreted in local timezone, not UTC
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        /**
         * Gets the date string for N days ago from today.
         * @param {number} daysAgo - Number of days ago.
         * @returns {string} Date string in YYYY-MM-DD format.
         */
        function NdayAgoDateString(daysAgo) {
            const date = new Date();
            date.setDate(date.getDate() - daysAgo);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * Validates if a value is a number and meets optional criteria.
         * @param {string|number} value - The value to validate.
         * @param {string} fieldName - Name of the field for error messages.
         * @param {boolean} [allowZero=false] - Whether zero is a valid input.
         * @param {boolean} [allowNegative=false] - Whether negative numbers are valid.
         * @param {boolean} [isOptional=false] - If true, empty/null values are considered valid.
         * @returns {string|null} Error message string or null if valid.
         */
        function validateNumberInput(value, fieldName, allowZero = false, allowNegative = false, isOptional = false) {
            if (isOptional && (value === null || value === undefined || String(value).trim() === '')) return null;
            const num = parseFloat(value);
            if (isNaN(num)) return `${fieldName} must be a number.`;
            if (!allowNegative && num < 0) return `${fieldName} cannot be negative.`;
            if (!allowZero && num === 0 && !isOptional) return `${fieldName} cannot be zero unless optional.`;
            return null; // No error
        }
        
        // --- Data Persistence Functions (localStorage) ---
        /**
         * Loads user profile, logs, and targets from localStorage.
         */
        function loadData() {
            const storedProfile = localStorage.getItem(PROFILE_KEY);
            const storedLogs = localStorage.getItem(LOGS_KEY);
            const storedTargets = localStorage.getItem(TARGETS_KEY);

            userProfile = storedProfile ? JSON.parse(storedProfile) : null;
            dailyLogs = storedLogs ? JSON.parse(storedLogs) : [];
            currentTargets = storedTargets ? JSON.parse(storedTargets) : {};
        }

        /**
         * Saves the current state of user profile, logs, and targets to localStorage.
         */
        function saveData() {
            localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
            localStorage.setItem(LOGS_KEY, JSON.stringify(dailyLogs));
            localStorage.setItem(TARGETS_KEY, JSON.stringify(currentTargets));
        }

        // --- Core Calculation Functions ---
        /**
         * Calculates Basal Metabolic Rate (BMR) using Mifflin-St Jeor equation.
         * Uses weight from the user's profile for this initial calculation.
         * @param {object} profile - The user's profile object.
         * @returns {number} Calculated BMR.
         */
        function calculateBMR(profile) {
            const weightKg = parseFloat(profile.currentWeight); // Use the initial weight from profile for BMR
            const heightCm = parseFloat(profile.height);
            const ageYears = parseFloat(profile.age);
            let bmr;
            if (profile.sex === 'male') {
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * ageYears) + 5;
            } else { // female
                bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * ageYears) - 161;
            }
            return bmr;
        }

        /**
         * Calculates initial Total Daily Energy Expenditure (TDEE).
         * @param {object} profile - The user's profile object.
         * @returns {number} Calculated initial TDEE.
         */
        function calculateInitialTDEE(profile) {
            const bmr = calculateBMR(profile);
            return bmr * parseFloat(profile.activityLevel);
        }

        /**
         * Calculates calorie and macronutrient targets.
         * @param {number} tdee - The current estimated TDEE.
         * @param {object} profile - The user's profile object.
         * @param {number} currentWeightForMacrosKg - The current body weight to use for macro calculations (e.g., trend weight).
         * @returns {object} Object containing target calories, protein, carbs, fat, and the TDEE used.
         */
        function calculateTargets(tdee, profile, currentWeightForMacrosKg) {
            const weeklyGoalKg = parseFloat(profile.weeklyGoal);
            // Daily calorie adjustment needed to meet the weekly weight goal
            const calorieAdjustment = weeklyGoalKg * (CALORIES_PER_KG_FAT_TISSUE / 7); 
            
            let targetCalories = tdee + calorieAdjustment;

            // Calculate protein grams based on target per kg of body weight
            const proteinGramsPerKg = parseFloat(profile.proteinGoalGramsPerKg);
            let proteinGrams = proteinGramsPerKg * currentWeightForMacrosKg;
            
            // Calculate fat grams based on percentage of total target calories
            const fatPercentage = parseFloat(profile.fatGoalPercentage) / 100;
            let fatGrams = (targetCalories * fatPercentage) / CALORIES_PER_G_FAT;

            // Ensure a minimum fat intake (e.g., 0.66g/kg as a rough minimum for health)
            const minFatGrams = 0.66 * currentWeightForMacrosKg; 
            if (fatGrams < minFatGrams) {
                fatGrams = minFatGrams;
            }
            
            let proteinCalories = proteinGrams * CALORIES_PER_G_PROTEIN;
            let fatCalories = fatGrams * CALORIES_PER_G_FAT;
            
            // Calculate remaining calories for carbohydrates
            let remainingCaloriesForCarbs = targetCalories - proteinCalories - fatCalories;

            // Handle cases where protein + fat calories exceed target (e.g., very low calorie target)
            if (remainingCaloriesForCarbs < 0) {
                console.warn("Calculated negative calories for carbs. Prioritizing protein, then minimum fat. Carbs will be low/zero.");
                const minFatCalories = minFatGrams * CALORIES_PER_G_FAT;
                // If current fat calories are above minimum, reduce them to make space, but not below min.
                if (fatCalories > minFatCalories) {
                    fatCalories = Math.max(minFatCalories, targetCalories - proteinCalories); 
                    fatGrams = fatCalories / CALORIES_PER_G_FAT;
                }
                // Recalculate remaining calories for carbs, ensuring it's not negative
                remainingCaloriesForCarbs = Math.max(0, targetCalories - proteinCalories - fatCalories);
            }

            const carbGrams = remainingCaloriesForCarbs / CALORIES_PER_G_CARB;
            
            // Recalculate total calories based on rounded macros for internal consistency
            targetCalories = (proteinGrams * CALORIES_PER_G_PROTEIN) + 
                             (carbGrams * CALORIES_PER_G_CARB) + 
                             (fatGrams * CALORIES_PER_G_FAT);

            return {
                calories: Math.round(targetCalories),
                protein: Math.round(proteinGrams),
                carbs: Math.round(carbGrams),
                fat: Math.round(fatGrams),
                estimatedTDEE: Math.round(tdee),
                lastTDEECalculationDate: getTodayDateString() // Record when these targets were set
            };
        }
        
        /**
         * Calculates the average weight from a subset of logs.
         * @param {Array<object>} logsSubset - Array of log objects.
         * @returns {number|null} Average weight or null if not calculable.
         */
        function getAverageWeight(logsSubset) {
            if (!logsSubset || logsSubset.length === 0) return null;
            // Filter out logs without valid weight data
            const validWeightLogs = logsSubset.filter(log => log.weight !== null && typeof log.weight === 'number' && log.weight > 0);
            if (validWeightLogs.length === 0) return null;
            return validWeightLogs.reduce((sum, log) => sum + log.weight, 0) / validWeightLogs.length;
        }


        // --- UI Update Functions ---
        /**
         * Shows the specified screen and hides others.
         * @param {string} screenId - The ID of the screen to show ('setupScreen' or 'dashboardScreen').
         */
        function showScreen(screenId) {
            setupScreen.style.display = 'none';
            dashboardScreen.style.display = 'none';
            document.getElementById(screenId).style.display = 'block';
        }

        /**
         * Updates the dashboard UI with current data.
         */
        function updateDashboardUI() {
            if (!userProfile) { // If no profile, show setup
                showScreen('setupScreen');
                return;
            }
            showScreen('dashboardScreen'); // Otherwise, show dashboard

            currentDateDisplay.textContent = formatDate(getTodayDateString());
            // Set default log date to today only if it's not already set (e.g., by user interaction)
            if (!logDateInput.value) { 
                logDateInput.value = getTodayDateString();
            }
            logDateDisplay.textContent = formatDate(logDateInput.value); // Update display for log button

            // Display current targets
            targetCaloriesDisplay.textContent = currentTargets.calories ? `${currentTargets.calories}` : 'N/A';
            targetProteinDisplay.textContent = currentTargets.protein ? `${currentTargets.protein}` : 'N/A';
            targetCarbsDisplay.textContent = currentTargets.carbs ? `${currentTargets.carbs}` : 'N/A';
            targetFatDisplay.textContent = currentTargets.fat ? `${currentTargets.fat}` : 'N/A';
            tdeeDisplay.textContent = currentTargets.estimatedTDEE ? `${currentTargets.estimatedTDEE}` : 'N/A';
            lastCheckinTDEEDateDisplay.textContent = currentTargets.lastTDEECalculationDate ? formatDate(currentTargets.lastTDEECalculationDate) : 'Initial Setup';

            // Update check-in button status based on available log data
            const analysisWindowStart = NdayAgoDateString(CHECKIN_ANALYSIS_DAYS_WINDOW -1); // -1 because window includes today
            // Filter logs within the analysis window that have complete data (weight & calories)
            const logsInWindow = dailyLogs.filter(log => 
                log.date >= analysisWindowStart && 
                log.weight !== null && typeof log.weight === 'number' && log.weight > 0 &&
                log.calories !== null && typeof log.calories === 'number' && log.calories > 0
            );
            
            daysLoggedForCheckinDisplay.textContent = `${logsInWindow.length}`;
            if (logsInWindow.length >= MIN_LOGS_FOR_CHECKIN) {
                checkinBtn.disabled = false;
                checkinBtn.classList.remove('button-secondary'); // Make it look active
            } else {
                checkinBtn.disabled = true;
                checkinBtn.classList.add('button-secondary'); // Make it look inactive
            }
        }
        
        // Event listener for log date input changes to prefill data
        logDateInput.addEventListener('change', () => {
            logDateDisplay.textContent = formatDate(logDateInput.value); // Update button text
            const existingLog = dailyLogs.find(log => log.date === logDateInput.value);
            if (existingLog) {
                logWeightInput.value = existingLog.weight || '';
                logProteinInput.value = existingLog.protein || '';
                logCarbsInput.value = existingLog.carbs || '';
                logFatInput.value = existingLog.fat || '';
                logSuccess.textContent = `Prefilled data for ${formatDate(logDateInput.value)}. You can update it.`;
                logError.textContent = ''; // Clear any previous error
            } else { // Clear fields if no log exists for the selected date
                logWeightInput.value = '';
                logProteinInput.value = '';
                logCarbsInput.value = '';
                logFatInput.value = '';
                logSuccess.textContent = '';
            }
        });


        // --- Event Handlers ---
        /**
         * Handles saving the initial user setup.
         */
        saveSetupBtn.addEventListener('click', () => {
            setupError.textContent = ''; // Clear previous errors
            const profile = {
                currentWeight: currentWeightInput.value,
                height: heightInput.value,
                age: ageInput.value,
                sex: sexSelect.value,
                activityLevel: activityLevelSelect.value,
                proteinGoalGramsPerKg: proteinGoalGramsPerKgInput.value,
                fatGoalPercentage: fatGoalPercentageInput.value,
                weeklyGoal: weeklyGoalSelect.value,
                setupDate: getTodayDateString()
            };

            // Validate all setup inputs
            let errors = [];
            errors.push(validateNumberInput(profile.currentWeight, "Current Weight"));
            errors.push(validateNumberInput(profile.height, "Height"));
            errors.push(validateNumberInput(profile.age, "Age"));
            errors.push(validateNumberInput(profile.proteinGoalGramsPerKg, "Protein Target"));
            const fatPercErr = validateNumberInput(profile.fatGoalPercentage, "Fat Target");
            if (!fatPercErr && (parseFloat(profile.fatGoalPercentage) < 20 || parseFloat(profile.fatGoalPercentage) > 50)) {
                 errors.push("Fat Target must be between 20% and 50%.");
            } else {
                errors.push(fatPercErr);
            }

            errors = errors.filter(e => e !== null); // Remove null (no error) entries
            if (errors.length > 0) {
                setupError.innerHTML = errors.join('<br>'); // Display errors
                return;
            }
            
            userProfile = profile;
            const initialTDEE = calculateInitialTDEE(userProfile);
            // Calculate initial targets using the setup weight
            currentTargets = calculateTargets(initialTDEE, userProfile, parseFloat(userProfile.currentWeight)); 
            
            // Create an initial log entry with the setup weight
            dailyLogs = [{
                date: userProfile.setupDate,
                weight: parseFloat(userProfile.currentWeight),
                protein: null, carbs: null, fat: null, calories: null // No food log initially
            }];

            saveData(); // Persist data
            updateDashboardUI(); // Switch to dashboard
        });

        /**
         * Handles logging daily data (weight and macros).
         */
        logDataBtn.addEventListener('click', () => {
            logError.textContent = ''; // Clear previous errors
            logSuccess.textContent = ''; // Clear previous success messages

            const date = logDateInput.value;
            const weightStr = logWeightInput.value;
            const proteinStr = logProteinInput.value;
            const carbsStr = logCarbsInput.value;
            const fatStr = logFatInput.value;

            let errors = [];
            if (!date) errors.push("Date is required.");
            
            // Weight is optional if only logging macros, but if provided, must be a valid number
            if (weightStr.trim() !== '') { // Only validate if not empty
                 errors.push(validateNumberInput(weightStr, "Weight", true, false)); // Allow zero, not negative
            }
            // Macros are optional, but if provided, must be valid numbers
            if (proteinStr.trim() !== '') errors.push(validateNumberInput(proteinStr, "Protein", true, false));
            if (carbsStr.trim() !== '') errors.push(validateNumberInput(carbsStr, "Carbs", true, false));
            if (fatStr.trim() !== '') errors.push(validateNumberInput(fatStr, "Fat", true, false));
            
            errors = errors.filter(e => e !== null);
            if (errors.length > 0) {
                logError.innerHTML = errors.join('<br>');
                return;
            }

            // Parse values, defaulting to null or 0 if not provided
            const weightVal = weightStr.trim() !== '' ? parseFloat(weightStr) : null;
            const proteinVal = proteinStr.trim() !== '' ? parseFloat(proteinStr) : 0;
            const carbsVal = carbsStr.trim() !== '' ? parseFloat(carbsStr) : 0;
            const fatVal = fatStr.trim() !== '' ? parseFloat(fatStr) : 0;

            let calories = null;
            // Calculate calories only if at least one macro is entered
            if (proteinStr.trim() !== '' || carbsStr.trim() !== '' || fatStr.trim() !== '') {
                 calories = (proteinVal * CALORIES_PER_G_PROTEIN) +
                            (carbsVal * CALORIES_PER_G_CARB) +
                            (fatVal * CALORIES_PER_G_FAT);
            }

            const logEntry = {
                date: date,
                weight: weightVal,
                protein: proteinStr.trim() !== '' ? proteinVal : null, // Store null if not entered
                carbs: carbsStr.trim() !== '' ? carbsVal : null,
                fat: fatStr.trim() !== '' ? fatVal : null,
                calories: calories !== null ? Math.round(calories) : null
            };

            // Remove existing log for this date (if any) to update, then add the new/updated entry
            dailyLogs = dailyLogs.filter(log => log.date !== date);
            dailyLogs.push(logEntry);
            dailyLogs.sort((a, b) => new Date(a.date) - new Date(b.date)); // Keep logs sorted by date

            saveData();
            updateDashboardUI(); // Refresh dashboard, especially check-in button status
            logSuccess.textContent = `Data logged successfully for ${formatDate(date)}!`;
        });

        /**
         * Handles the weekly check-in process to update TDEE and targets.
         */
        checkinBtn.addEventListener('click', () => {
            checkinMessage.textContent = 'Performing check-in...';
            
            // Get logs within the analysis window that have full data
            const analysisWindowStartDate = NdayAgoDateString(CHECKIN_ANALYSIS_DAYS_WINDOW - 1);
            const logsForAnalysis = dailyLogs
                .filter(log => 
                    log.date >= analysisWindowStartDate &&
                    log.weight !== null && typeof log.weight === 'number' && log.weight > 0 &&
                    log.calories !== null && typeof log.calories === 'number' && log.calories > 0
                )
                .sort((a,b) => new Date(a.date) - new Date(b.date)); // Sort oldest to newest

            if (logsForAnalysis.length < MIN_LOGS_FOR_CHECKIN) {
                checkinMessage.textContent = `Not enough full log days in the last ${CHECKIN_ANALYSIS_DAYS_WINDOW} days. Need ${MIN_LOGS_FOR_CHECKIN}, found ${logsForAnalysis.length}. Please log more data.`;
                return;
            }

            // Calculate trend weights for the start and end of the analysis period
            const startTrendLogs = logsForAnalysis.slice(0, WEIGHT_TREND_DAYS);
            const endTrendLogs = logsForAnalysis.slice(-WEIGHT_TREND_DAYS); // Last N days

            const startTrendWeight = getAverageWeight(startTrendLogs);
            const endTrendWeight = getAverageWeight(endTrendLogs);

            if (startTrendWeight === null || endTrendWeight === null) {
                checkinMessage.textContent = 'Could not determine weight trend. Ensure sufficient weight logs at the start and end of the analysis period.';
                return;
            }

            const weightChangeKg = endTrendWeight - startTrendWeight;
            
            // Ensure the date range for trend weights is sensible and not overlapping too much if data is sparse
            const firstTrendDay = new Date(startTrendLogs[0].date);
            const lastTrendDay = new Date(endTrendLogs[endTrendLogs.length-1].date);
            // Effective duration over which the trend weight change is observed
            const daysInTrendPeriod = (lastTrendDay - firstTrendDay) / (1000 * 60 * 60 * 24); 

            // Check if the trend period is too short (e.g. less than a week if WEIGHT_TREND_DAYS is 3)
            if (daysInTrendPeriod < (WEIGHT_TREND_DAYS * 2 - 2) && logsForAnalysis.length < (MIN_LOGS_FOR_CHECKIN + WEIGHT_TREND_DAYS -1) ) { 
                 checkinMessage.textContent = `Not enough distinct data points or spread for reliable weight trend. Period: ${daysInTrendPeriod.toFixed(0)} days. Log more consistently.`;
                 return;
            }

            // Calculate average daily calories consumed over the entire analysis period
            const averageDailyCaloriesInPeriod = logsForAnalysis.reduce((sum, log) => sum + log.calories, 0) / logsForAnalysis.length;

            // Determine the duration of the entire analysis period for TDEE calculation
            const firstDateOfAnalysis = new Date(logsForAnalysis[0].date);
            const lastDateOfAnalysis = new Date(logsForAnalysis[logsForAnalysis.length - 1].date);
            // Ensure duration is at least 1 day to avoid division by zero
            const durationOfAnalysisPeriodDays = Math.max(1, (lastDateOfAnalysis - firstDateOfAnalysis) / (1000 * 60 * 60 * 24)); 

            // Calculate the implied daily calorie surplus or deficit based on weight change
            const dailyCalorieSurplusOrDeficit = (weightChangeKg * CALORIES_PER_KG_FAT_TISSUE) / durationOfAnalysisPeriodDays;

            // Calculate the expenditure based on intake and weight change
            const calculatedExpenditure = averageDailyCaloriesInPeriod - dailyCalorieSurplusOrDeficit;

            if (isNaN(calculatedExpenditure) || !isFinite(calculatedExpenditure)) {
                checkinMessage.textContent = 'Error calculating expenditure. Check logs for anomalies (e.g., very large weight changes over short periods, or zero calorie days with weight changes).';
                return;
            }
            
            // Smooth the TDEE update to prevent drastic changes
            const previousTDEE = currentTargets.estimatedTDEE || calculateInitialTDEE(userProfile); // Fallback to initial if no TDEE yet
            const newSmoothedTDEE = (previousTDEE * (1 - TDEE_SMOOTHING_FACTOR)) + (calculatedExpenditure * TDEE_SMOOTHING_FACTOR);

            // Use the end trend weight (most recent stable weight) for calculating new macro targets
            const latestWeightForMacros = endTrendWeight; 

            currentTargets = calculateTargets(newSmoothedTDEE, userProfile, latestWeightForMacros);
            
            saveData();
            updateDashboardUI();
            // Provide detailed feedback to the user
            checkinMessage.innerHTML = `Check-in complete! <br>
                                       Trend Weight Change: ${weightChangeKg.toFixed(2)} kg over approx. ${durationOfAnalysisPeriodDays.toFixed(0)} days.<br>
                                       Avg Calories Logged: ${averageDailyCaloriesInPeriod.toFixed(0)} kcal/day.<br>
                                       Implied Expenditure: ${calculatedExpenditure.toFixed(0)} kcal/day.<br>
                                       New Smoothed TDEE: ${currentTargets.estimatedTDEE} kcal. Targets adjusted.`;
        });

        /**
         * Handles resetting all application data.
         */
        resetDataBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to reset all data? This cannot be undone.")) {
                localStorage.removeItem(PROFILE_KEY);
                localStorage.removeItem(LOGS_KEY);
                localStorage.removeItem(TARGETS_KEY);
                userProfile = null;
                dailyLogs = [];
                currentTargets = {};
                // Clear any messages on UI
                checkinMessage.textContent = '';
                logSuccess.textContent = '';
                logError.textContent = '';
                setupError.textContent = '';
                logDateInput.value = ''; // Clear date input
                init(); // Re-initialize the app (will show setup screen)
            }
        });

        /**
         * Handles viewing logs in the browser console.
         */
        viewLogsBtn.addEventListener('click', () => {
            console.log("User Profile:", userProfile);
            console.log("Daily Logs:", dailyLogs);
            console.log("Current Targets:", currentTargets);
            alert("Logs have been printed to the browser console (usually F12 or Right-click -> Inspect -> Console).");
        });

        // --- Application Initialization ---
        /**
         * Initializes the application by loading data and showing the appropriate screen.
         */
        function init() {
            loadData(); // Load any existing data from localStorage
            if (userProfile) { // If a profile exists, go to dashboard
                showScreen('dashboardScreen');
                updateDashboardUI();
                // Set default log date to today and trigger change to prefill if data exists for today
                if (!logDateInput.value) { // Only set if not already set (e.g. by user)
                    logDateInput.value = getTodayDateString();
                }
                logDateInput.dispatchEvent(new Event('change')); 
            } else { // Otherwise, show the setup screen
                showScreen('setupScreen');
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
